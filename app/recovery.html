<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shamir Recovery | The Murderer's Lock</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Playfair+Display:wght@700;900&family=JetBrains+Mono:wght@600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-void: #000000;
      --bg-deep: #0A0A0F;
      --bg-card: #12121A;
      --neon-pink: #FF10F0;
      --neon-cyan: #00F5FF;
      --neon-purple: #B624FF;
      --neon-gold: #FFD700;
      --neon-lime: #39FF14;
      --neon-orange: #FF6600;
      --oil-slick: linear-gradient(135deg, #FF10F0 0%, #B624FF 15%, #00F5FF 30%, #39FF14 45%, #FFD700 60%, #FF6600 75%, #FF10F0 100%);
      --text-white: #FFFFFF;
      --text-silver: #E0E0E0;
      --text-gray: #808080;
    }
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-void);
      color: var(--text-white);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .neon-bg {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at 20% 30%, rgba(255, 16, 240, 0.15) 0%, transparent 50%),
                  radial-gradient(ellipse at 80% 70%, rgba(0, 245, 255, 0.15) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 32px 24px;
      position: relative;
      z-index: 1;
    }
    .back-link {
      color: var(--neon-cyan);
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 24px;
      display: inline-block;
      transition: opacity 0.3s;
    }
    .back-link:hover { opacity: 0.8; }
    .page-title {
      font-family: 'Playfair Display', serif;
      font-size: 36px;
      font-weight: 900;
      margin-bottom: 8px;
      background: var(--oil-slick);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .page-subtitle {
      color: var(--text-silver);
      font-size: 14px;
      margin-bottom: 40px;
    }
    .recovery-card {
      background: rgba(18, 18, 26, 0.8);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 16, 240, 0.2);
      border-radius: 24px;
      padding: 48px;
      margin-bottom: 32px;
    }
    .recovery-card:hover {
      border-color: rgba(182, 36, 255, 0.4);
      box-shadow: 0 0 40px rgba(182, 36, 255, 0.2);
    }
    .form-group {
      margin-bottom: 24px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--neon-purple);
    }
    .form-input {
      width: 100%;
      padding: 16px 20px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(182, 36, 255, 0.3);
      border-radius: 12px;
      color: var(--text-white);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      transition: all 0.3s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--neon-purple);
      box-shadow: 0 0 20px rgba(182, 36, 255, 0.3);
    }
    .btn {
      padding: 18px 32px;
      border: 2px solid;
      border-radius: 12px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 12px;
      margin-top: 8px;
    }
    .btn-primary {
      background: rgba(182, 36, 255, 0.1);
      border-color: var(--neon-purple);
      color: var(--neon-purple);
      box-shadow: 0 0 20px rgba(182, 36, 255, 0.4);
    }
    .btn-primary:hover {
      background: rgba(182, 36, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 0 40px rgba(182, 36, 255, 0.6);
    }
    .btn-secondary {
      background: transparent;
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
    }
    .btn-secondary:hover {
      background: rgba(0, 245, 255, 0.1);
      transform: translateY(-2px);
    }
    .error-msg {
      color: var(--neon-pink);
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }
    .error-msg.visible { display: block; }
    .success-msg {
      color: var(--neon-lime);
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }
    .success-msg.visible { display: block; }
    .shard-box {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(182, 36, 255, 0.3);
      border-radius: 12px;
      color: var(--text-silver);
      word-break: break-all;
      margin-bottom: 16px;
    }
    .step-badge {
      display: inline-block;
      padding: 6px 14px;
      background: rgba(182, 36, 255, 0.2);
      border: 2px solid var(--neon-purple);
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 20px;
    }
    .setup-view .recover-content { display: none; }
    .setup-view .setup-content { display: block; }
    .recover-view .setup-content { display: none; }
    .recover-view .recover-content { display: block; }
  </style>
</head>
<body>
  <div class="neon-bg"></div>
  <div class="container">
    <a href="vault.html?id=" id="back-link" class="back-link">← Back to Vault</a>

    <h1 class="page-title">Shamir Recovery</h1>
    <p class="page-subtitle">2-of-3 secret sharing. Store 3 shards in different places. Any 2 can recover your vault.</p>

    <div class="recovery-card" id="recovery-view">
      <div class="setup-content">
        <span class="step-badge">Setup</span>
        <h3 style="margin-bottom: 24px; font-size: 20px;">Generate Recovery Shards</h3>
        <p style="color: var(--text-silver); margin-bottom: 24px;">Unlock your vault first, then generate 3 shards. Store each in a safe place (e.g., safe, lawyer, family). You need any 2 to recover.</p>
        <form id="generate-form">
          <div class="form-group">
            <label class="form-label">Vault Password (to split)</label>
            <input type="password" class="form-input" id="gen-password" placeholder="Enter vault password" required>
          </div>
          <button type="submit" class="btn btn-primary">Generate 3 Shards</button>
          <p class="error-msg" id="gen-error"></p>
        </form>
        <div id="shards-output" style="display: none; margin-top: 32px;">
          <p style="color: var(--neon-lime); margin-bottom: 16px;">✓ Save these shards securely. You need any 2 to recover.</p>
          <div class="shard-box" id="shard-1"></div>
          <div class="shard-box" id="shard-2"></div>
          <div class="shard-box" id="shard-3"></div>
        </div>
      </div>

      <div class="recover-content">
        <span class="step-badge">Recover</span>
        <h3 style="margin-bottom: 24px; font-size: 20px;">Recover Vault with Shards</h3>
        <p style="color: var(--text-silver); margin-bottom: 24px;">Enter any 2 of your 3 recovery shards to reconstruct the vault password.</p>
        <button type="button" class="btn btn-secondary" id="load-shards-btn" style="margin-bottom: 24px;">Load from this device</button>
        <form id="recover-form">
          <div class="form-group">
            <label class="form-label">Shard 1</label>
            <input type="text" class="form-input" id="recover-shard-1" placeholder="Paste first shard (hex) or load from device" required>
          </div>
          <div class="form-group">
            <label class="form-label">Shard 2</label>
            <input type="text" class="form-input" id="recover-shard-2" placeholder="Paste second shard (hex) or load from device" required>
          </div>
          <button type="submit" class="btn btn-primary">Recover Vault</button>
          <p class="error-msg" id="recover-error"></p>
          <p class="success-msg" id="recover-success"></p>
        </form>
      </div>
    </div>

    <div style="display: flex; gap: 12px;">
      <button type="button" class="btn btn-primary" id="tab-setup">Generate Shards</button>
      <button type="button" class="btn btn-secondary" id="tab-recover">Recover with Shards</button>
    </div>
  </div>

  <!-- PIN prompt for encrypted shards -->
  <div id="recovery-pin-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; padding: 24px;">
    <div style="background: rgba(18,18,26,0.98); border: 2px solid var(--neon-purple); border-radius: 24px; padding: 48px; max-width: 400px; width: 100%;">
      <h3 style="font-size: 20px; margin-bottom: 16px; color: var(--neon-purple);">Enter PIN to decrypt shards</h3>
      <input type="password" inputmode="numeric" id="recovery-pin-input" placeholder="••••" maxlength="12"
        style="width: 100%; padding: 16px; margin-bottom: 20px; background: rgba(0,0,0,0.5); border: 2px solid rgba(182,36,255,0.3); border-radius: 12px; color: white; font-size: 18px;">
      <div style="display: flex; gap: 12px;">
        <button type="button" class="btn btn-secondary" id="recovery-pin-cancel" style="flex: 1;">Cancel</button>
        <button type="button" class="btn btn-primary" id="recovery-pin-ok" style="flex: 1; border-color: var(--neon-purple); color: var(--neon-purple);">Decrypt</button>
      </div>
    </div>
  </div>

  <script src="js/validate.js"></script>
  <script src="js/shard-protection.js"></script>
  <script src="js/proof-of-work-visualizer.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const vaultId = params.get('id');
    document.getElementById('back-link').href = vaultId ? 'vault.html?id=' + vaultId : 'dashboard.html';

    const view = document.getElementById('recovery-view');
    document.getElementById('tab-setup').addEventListener('click', () => {
      view.classList.add('setup-view');
      view.classList.remove('recover-view');
    });
    document.getElementById('tab-recover').addEventListener('click', () => {
      view.classList.remove('setup-view');
      view.classList.add('recover-view');
    });
    view.classList.add('setup-view');

    document.getElementById('load-shards-btn')?.addEventListener('click', async () => {
      if (!vaultId) {
        alert('Open a vault first to load shards from this device.');
        return;
      }
      const stored = localStorage.getItem('vault_shards_' + vaultId);
      if (!stored) {
        alert('No shards found for this vault on this device.');
        return;
      }
      let shards;
      try {
        shards = JSON.parse(stored);
      } catch {
        alert('Invalid shard data.');
        return;
      }
      if (typeof ShardProtection !== 'undefined' && ShardProtection.isEncrypted(shards)) {
        document.getElementById('recovery-pin-modal').style.display = 'flex';
        document.getElementById('recovery-pin-input').value = '';
        window._pendingEncryptedShards = shards;
      } else {
        if (Array.isArray(shards) && shards.length >= 2) {
          document.getElementById('recover-shard-1').value = shards[0];
          document.getElementById('recover-shard-2').value = shards[1];
        }
      }
    });

    document.getElementById('recovery-pin-ok')?.addEventListener('click', async () => {
      const pin = document.getElementById('recovery-pin-input').value;
      if (!pin) return;
      if (window._pendingShardsToEncrypt) {
        const { shards, vaultId } = window._pendingShardsToEncrypt;
        try {
          const encrypted = await ShardProtection.encryptShards(shards, pin);
          localStorage.setItem('vault_shards_' + vaultId, JSON.stringify(encrypted));
          document.getElementById('recovery-pin-modal').style.display = 'none';
          document.querySelector('#recovery-pin-modal h3').textContent = 'Enter PIN to decrypt shards';
          document.getElementById('recovery-pin-ok').textContent = 'Decrypt';
          window._pendingShardsToEncrypt = null;
        } catch (e) {
          alert(e.message || 'Failed to encrypt.');
        }
      } else if (window._pendingEncryptedShards) {
        try {
          const decrypted = await ShardProtection.decryptShards(window._pendingEncryptedShards, pin);
          document.getElementById('recover-shard-1').value = decrypted[0] || '';
          document.getElementById('recover-shard-2').value = decrypted[1] || '';
          document.getElementById('recovery-pin-modal').style.display = 'none';
          window._pendingEncryptedShards = null;
        } catch (e) {
          alert('Wrong PIN or corrupted shards.');
        }
      }
    });

    document.getElementById('recovery-pin-cancel')?.addEventListener('click', () => {
      document.getElementById('recovery-pin-modal').style.display = 'none';
      if (window._pendingShardsToEncrypt) {
        const { vaultId } = window._pendingShardsToEncrypt;
        localStorage.setItem('vault_shards_' + vaultId, JSON.stringify(window._pendingShardsToEncrypt.shards));
        window._pendingShardsToEncrypt = null;
      }
      window._pendingEncryptedShards = null;
      document.querySelector('#recovery-pin-modal h3').textContent = 'Enter PIN to decrypt shards';
      document.getElementById('recovery-pin-ok').textContent = 'Decrypt';
    });

    document.getElementById('generate-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const err = document.getElementById('gen-error');
      err.classList.remove('visible');
      const password = document.getElementById('gen-password').value;

      try {
        const res = await fetch('/api/generate-shards', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ secret: password })
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'Failed to generate shards');

        const shards = data.shards;
        document.getElementById('shard-1').textContent = shards[0];
        document.getElementById('shard-2').textContent = shards[1];
        document.getElementById('shard-3').textContent = shards[2];
        document.getElementById('shards-output').style.display = 'block';
        if (vaultId) {
          if (typeof ShardProtection !== 'undefined' && ShardProtection.hasPin()) {
            document.querySelector('#recovery-pin-modal h3').textContent = 'Enter PIN to encrypt shards';
            document.getElementById('recovery-pin-ok').textContent = 'Encrypt & Save';
            window._pendingShardsToEncrypt = { shards, vaultId };
            document.getElementById('recovery-pin-modal').style.display = 'flex';
            document.getElementById('recovery-pin-input').value = '';
          } else {
            localStorage.setItem('vault_shards_' + vaultId, JSON.stringify(shards));
          }
        }
      } catch (ex) {
        err.textContent = ex.message || 'Failed to generate shards.';
        err.classList.add('visible');
      }
    });

    document.getElementById('recover-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const err = document.getElementById('recover-error');
      const ok = document.getElementById('recover-success');
      err.classList.remove('visible');
      ok.classList.remove('visible');
      const s1 = document.getElementById('recover-shard-1').value.replace(/\s/g, '');
      const s2 = document.getElementById('recover-shard-2').value.replace(/\s/g, '');
      const submitBtn = e.target.querySelector('button[type="submit"]');

      if (typeof Validate !== 'undefined') {
        const check = Validate.validateShardPair(s1, s2);
        if (!check.valid) {
          err.textContent = check.error || 'Invalid shard format.';
          err.classList.add('visible');
          return;
        }
      }

      let pow = null;
      if (typeof ProofOfWork !== 'undefined') {
        pow = ProofOfWork.show('#recovery-view', { message: 'Reconstructing vault...', duration: 5000 });
        if (submitBtn) submitBtn.disabled = true;
      }

      try {
        const vaults = JSON.parse(localStorage.getItem('vault_manager_vaults') || '[]');
        const vault = vaultId ? vaults.find(x => x.id === vaultId) : null;
        const enc = (vault && vault.salt && vault.iv && vault.encryptedData)
          ? { salt: vault.salt, iv: vault.iv, encryptedData: vault.encryptedData }
          : (vaultId ? (() => {
              const d = JSON.parse(localStorage.getItem('vault_data_' + vaultId) || '{}');
              return d.salt && d.iv && d.encryptedData ? d : null;
            })() : null);

        if (!vaultId || !enc) {
          err.textContent = 'Open a vault first, then use recovery from the vault page.';
          err.classList.add('visible');
          return;
        }

        const res = await fetch('/api/recover-vault', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shards: [s1, s2],
            vaultId,
            salt: enc.salt,
            encryptedData: enc.encryptedData,
            iv: enc.iv
          })
        });
        const data = await res.json();

        if (!res.ok) {
          err.textContent = data.message || data.error || (res.status === 429 ? 'Too many attempts. Try again later.' : 'Invalid shards');
          err.classList.add('visible');
          return;
        }

        const token = data.sessionToken;
        if (!token) {
          err.textContent = 'Recovery failed: no session token.';
          err.classList.add('visible');
          return;
        }

        const unlockRes = await fetch('/api/unlock-vault', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionToken: token, vaultId })
        });
        const unlockData = await unlockRes.json();

        if (!unlockRes.ok) {
          err.textContent = unlockData.message || unlockData.error || 'Session expired. Try recovery again.';
          err.classList.add('visible');
          return;
        }

        if (vault) {
          vault.murderCount = 0;
          vault.lockjawEngaged = false;
          vault.locked = false;
          localStorage.setItem('vault_manager_vaults', JSON.stringify(vaults));
        }
        sessionStorage.setItem('vault_contents_' + vaultId, unlockData.contents || '');
        ok.textContent = '✓ Vault recovered. Security state reset. Redirecting...';
        ok.classList.add('visible');
        setTimeout(() => { window.location.href = 'vault.html?id=' + vaultId; }, 1500);
      } catch (ex) {
        err.textContent = ex.message || 'Invalid shards. Ensure you have 2 valid shards from the same split.';
        err.classList.add('visible');
      } finally {
        if (pow) pow.stop();
        if (submitBtn) submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
